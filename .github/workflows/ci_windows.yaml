name: Test Windows

on:
  pull_request:
    paths:
      - "**/*.go"
      - "**/*.c"
      - "**/*.h"
      - ".github/workflows/ci.yaml"

jobs:
  run_test:
    strategy:
      fail-fast: true
      matrix:
        go_version:
          - 1.19.x
        targets:
          - windows/amd64

    runs-on: windows-latest
    steps:
    - name: Set up scoop
      run: |
        Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh');
        echo "::add-path::$HOME\scoop\shims";

    - name: Debug PATH
      run: echo "$Env:Path"

    - name: Set up scoop extras
      run: scoop bucket add extras;

    - name: Install packages
      run: scoop install wget unzip

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ matrix.go_version }}
        stable: true

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
      with:
        submodules: true

    - name: Install Godot 4.0 beta 2
      run: |
        wget https://downloads.tuxfamily.org/godotengine/4.0/beta2/Godot_v4.0-beta1_win64.exe.zip
        unzip Godot_v4.0-beta2_win64.exe.zip -d ./
      shell: bash

    - name: Build
      run: |
        make build
      shell: bash
      env:
        GODOT_BIN: ./Godot_v4.0-beta2_win64.exe

    - name: List Artifacts Directory
      run: |
        ls -alh test/demo/lib
        ls -alh test/demo/
      shell: bash

    - name: Test
      run: make test
      shell: bash
      env:
        CI: 1
        LOG_LEVEL: "trace"
        LANG: "en_US.utf8"
        GODOT: "./Godot_v4.0-beta2_win64.exe"
