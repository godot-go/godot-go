{{ $view := . -}}
package gdextension

/*------------------------------------------------------------------------------
//   This code was generated by template builtinclasses.go.tmpl.
//
//   Changes to this file may cause incorrect behavior and will be lost if
//   the code is regenerated. Any updates should be done in
//   "builtinclasses.go.tmpl" so they can be included in the generated
//   code.
//----------------------------------------------------------------------------*/

//revive:disable

// #include <godot/gdnative_interface.h>
// #include <stdio.h>
// #include <stdlib.h>
import "C"
import (
    "unsafe"

	. "github.com/godot-go/godot-go/pkg/gdnative"
)

{{ $sizes := $view.Float64BuiltinClassSize -}}

// built-in classes
{{ range $i, $c := $view.FilterBuiltinClasses -}}

{{ $enumTypeName := (print "GDNATIVE_VARIANT_TYPE_" (screamingSnake $c.Name)) -}}

/*
 * {{ $c.Name }}
 * indexingReturnType: {{ $c.IndexingReturnType }}
 * isKeyed: {{ $c.IsKeyed }}
 * hasDestructor: {{ $c.HasDestructor }}
 */
type {{ $c.Name }} struct {
    opaque [{{ $sizes.FindSize $c.Name }}]uint8
}

type {{ lowerFirstChar $c.Name }}MethodBindings struct {
    {{ range $j, $mb := $c.Constructors -}}
    constructor_{{ $j }} GDNativePtrConstructor
    {{ end -}}

    {{ if $c.HasDestructor -}}
    destructor GDNativePtrDestructor
    {{ end -}}

    {{ range $j, $mb := $c.Methods -}}
    method_{{ $mb.Name }} GDNativePtrBuiltInMethod
    {{ end -}}

    {{ range $j, $mb := $c.Members -}}
    member_{{ $mb.Name }}_setter GDNativePtrSetter
    member_{{ $mb.Name }}_getter GDNativePtrGetter
    {{ end -}}

    {{ if gt (len $c.IndexingReturnType) 0 -}}
    indexed_setter GDNativePtrIndexedSetter
    indexed_getter GDNativePtrIndexedGetter
    {{ end -}}

    {{ if $c.IsKeyed -}}
    keyed_setter  GDNativePtrKeyedSetter
    keyed_getter  GDNativePtrKeyedGetter
    keyed_checker GDNativePtrKeyedChecker
    {{ end -}}

    {{ range $j, $op := $c.Operators -}}
        {{ $enumOpName := (print "GDNATIVE_VARIANT_OP_" (upper (getOperatorIdName $op.Name))) -}}
        {{ if gt (len $op.RightType) 0 -}}
        operator_{{ getOperatorIdName $op.Name }}_{{ $op.RightType }} GDNativePtrOperatorEvaluator
        {{ else -}}
        operator_{{ getOperatorIdName $op.Name }} GDNativePtrOperatorEvaluator
        {{ end -}}
    {{ end -}}
}

var global{{ $c.Name }}MethodBindings {{ lowerFirstChar $c.Name }}MethodBindings

func {{ lowerFirstChar $c.Name }}InitBindings() {
    {{ range $j, $mb := $c.Constructors -}}
    global{{ $c.Name }}MethodBindings.constructor_{{ $j }} = GDNativeInterface_variant_get_ptr_constructor(internal.gdnInterface, {{ $enumTypeName }}, {{ $j }})
    {{ end -}}

    {{ if $c.HasDestructor -}}
    global{{ $c.Name }}MethodBindings.destructor = GDNativeInterface_variant_get_ptr_destructor(internal.gdnInterface, {{ $enumTypeName }})
    {{ end -}}

    {{ range $j, $mb := $c.Methods -}}
    global{{ $c.Name }}MethodBindings.method_{{ $mb.Name }} = GDNativeInterface_variant_get_ptr_builtin_method(internal.gdnInterface, {{ $enumTypeName }}, "{{ $mb.Name }}", {{ $mb.Hash }})
    {{ end -}}

    {{ range $j, $mb := $c.Members -}}
    global{{ $c.Name }}MethodBindings.member_{{ $mb.Name }}_setter = GDNativeInterface_variant_get_ptr_setter(internal.gdnInterface, {{ $enumTypeName }}, "{{ $mb.Name }}")
    global{{ $c.Name }}MethodBindings.member_{{ $mb.Name }}_getter = GDNativeInterface_variant_get_ptr_getter(internal.gdnInterface, {{ $enumTypeName }}, "{{ $mb.Name }}")
    {{ end -}}

    {{ if gt (len $c.IndexingReturnType) 0 -}}
    global{{ $c.Name }}MethodBindings.indexed_setter = GDNativeInterface_variant_get_ptr_indexed_setter(internal.gdnInterface, {{ $enumTypeName }})
    global{{ $c.Name }}MethodBindings.indexed_getter = GDNativeInterface_variant_get_ptr_indexed_getter(internal.gdnInterface, {{ $enumTypeName }})
    {{ end -}}

    {{ if $c.IsKeyed -}}
    global{{ $c.Name }}MethodBindings.keyed_setter  = GDNativeInterface_variant_get_ptr_keyed_setter(internal.gdnInterface, {{ $enumTypeName }})
    global{{ $c.Name }}MethodBindings.keyed_getter  = GDNativeInterface_variant_get_ptr_keyed_getter(internal.gdnInterface, {{ $enumTypeName }})
    global{{ $c.Name }}MethodBindings.keyed_checker = GDNativeInterface_variant_get_ptr_keyed_checker(internal.gdnInterface, {{ $enumTypeName }})
    {{ end -}}

    {{ range $j, $op := $c.Operators -}}
        {{ $enumOpName := (print "GDNATIVE_VARIANT_OP_" (upper (getOperatorIdName $op.Name))) -}}
        {{ if gt (len $op.RightType) 0 -}}
        {{ if eq $op.RightType "Variant" -}}
        global{{ $c.Name }}MethodBindings.operator_{{ getOperatorIdName $op.Name }}_{{ $op.RightType }} = GDNativeInterface_variant_get_ptr_operator_evaluator(internal.gdnInterface, {{ $enumOpName }}, {{ $enumTypeName }}, GDNATIVE_VARIANT_TYPE_NIL)
        {{ else -}}
        {{ $enumRightTypeName := (print "GDNATIVE_VARIANT_TYPE_" (screamingSnake $op.RightType)) -}}
        global{{ $c.Name }}MethodBindings.operator_{{ getOperatorIdName $op.Name }}_{{ $op.RightType }} = GDNativeInterface_variant_get_ptr_operator_evaluator(internal.gdnInterface, {{ $enumOpName }}, {{ $enumTypeName }}, {{ $enumRightTypeName }})
        {{ end -}}
        {{ else -}}
        global{{ $c.Name }}MethodBindings.operator_{{ getOperatorIdName $op.Name }} = GDNativeInterface_variant_get_ptr_operator_evaluator(internal.gdnInterface, {{ $enumOpName }}, {{ $enumTypeName }}, GDNATIVE_VARIANT_TYPE_NIL)
        {{ end -}}
    {{ end -}}
}

func (c *{{ $c.Name }}) ptr() GDNativeTypePtr {
    return (GDNativeTypePtr)(unsafe.Pointer(&c.opaque))
}

// constructors
{{ range $j, $con := $c.FilterConstructors -}}

// New{{ $c.Name }}, index: {{ $con.Index }}
func New{{ $c.Name }}{{ with $con.Arguments }}With{{- range $k, $arg := $con.Arguments -}}{{ upperFirstChar (goArgumentType $arg.Type) }}{{- end -}}{{- end -}}(
    {{- range $k, $arg := $con.Arguments -}}
		{{ goArgumentName $arg.Name }} {{ goArgumentType $arg.Type }},
	{{- end -}}
) {{ $c.Name }} {
    cx := {{ $c.Name }}{}

    ptr := cx.ptr()

    {{ if $con.Arguments -}}
    var args [{{ len $con.Arguments }}]GDNativeTypePtr

    {{ range $k, $arg := $con.Arguments -}}
        // {{ $arg.Type }}
        {{ if eq (goArgumentType $arg.Type) "string" -}}
        cv{{ $k }} := NewStringWithLatin1Chars({{ goArgumentName $arg.Name }})
        defer cv{{ $k }}.Destroy()
        args[{{ $k }}] = cv{{ $k }}.ptr()

        {{ else -}}
        {{ if typeHasPtr $arg.Type -}}
        args[{{ $k }}] = (GDNativeTypePtr)({{ goArgumentName $arg.Name }}.ptr())
        {{ else -}}
        args[{{ $k }}] = (GDNativeTypePtr)(unsafe.Pointer(&{{ goArgumentName $arg.Name }}))
        {{ end -}}
        {{ end -}}
	{{ end -}}
    {{ end -}}

    callBuiltinConstructor(global{{ $c.Name }}MethodBindings.constructor_{{ $j }}, ptr, {{range $k, $arg := $con.Arguments -}}args[{{ $k }}],{{- end -}})

    return cx
}
{{ end }}

{{ if $c.HasDestructor -}}
func (cx *{{ $c.Name }}) Destroy() {
    md := (GDNativePtrDestructor)(global{{ $c.Name }}MethodBindings.destructor)
    bx := (GDNativeTypePtr)(cx.ptr())
    CallFunc_GDNativePtrDestructor(md, bx)
}
{{ end }}

// methods
{{ range $j, $m := $c.Methods -}}
{{ $fnReturnType := goReturnType $m.ReturnType }}
{{ $hasSomeArguments := (or $m.Arguments $m.IsVararg) }}
/* {{ goMethodName $m.Name }} : {{ $m.Name }}
 * is_vararg = {{ $m.IsVararg }}, is_static = {{ $m.IsStatic }}
 * goReturnType({{ $m.ReturnType }}) -> {{ $fnReturnType }}
 */
func (cx *{{ $c.Name }}) {{ goMethodName $m.Name }}(
    {{- range $k, $arg := $m.Arguments -}}
		{{ goArgumentName $arg.Name }} {{ goArgumentType $arg.Type }},
	{{- end -}}
    {{ if $m.IsVararg -}}
        varargs ...Variant
    {{- end -}}
) {{ $fnReturnType }} {
    mb := global{{ $c.Name }}MethodBindings.method_{{ $m.Name }}

    {{ if $m.IsStatic -}}
    bx := (GDNativeTypePtr)(nullptr)
    {{ else -}}
    bx := cx.ptr()
    {{ end -}}

    {{ if $hasSomeArguments -}}
    sz := unsafe.Sizeof(nullptr) * uintptr({{ len $m.Arguments -}} {{ if $m.IsVararg -}} + len(varargs) + 1 {{- end }})
    argBytes := unsafe.Pointer(C.malloc(C.size_t(sz)))

	args := (*[MAX_ARG_COUNT]GDNativeTypePtr)(argBytes)
    {{ end -}}

    {{ range $j, $arg := $m.Arguments -}}
    {{ if goHasArgumentTypeEncoder $arg.Type }}
    // {{ upperFirstChar (goArgumentType $arg.Type) }}Encoder
    args[{{ $j }}] = (GDNativeTypePtr)(unsafe.Pointer(&{{ goArgumentName $arg.Name }}))
    {{ else }}
    args[{{ $j }}] = (GDNativeTypePtr)(unsafe.Pointer(&{{ goArgumentName $arg.Name }}))
    {{ end }}
    {{ end }}{{/* range $m.Arguments */}}

    {{ if $m.IsVararg -}}
    for i := range varargs {
        args[i + {{ len $m.Arguments }}] = (GDNativeTypePtr)(unsafe.Pointer(&varargs[i]))
    }
    {{ end -}}

    {{ if $fnReturnType -}}
    ret := callBuiltinMethodPtrRet[{{ $fnReturnType }}](mb, bx, {{ if $hasSomeArguments -}}args{{ else }}nil{{ end }})

    {{ if $hasSomeArguments -}}
    C.free(argBytes)
    {{ end -}}
    return ret
    {{ else -}}
    callBuiltinMethodPtrNoRet(mb, bx, {{ if $hasSomeArguments -}}args{{ else }}nil{{ end }})

    {{ if $hasSomeArguments -}}
    C.free(argBytes)
    {{ end -}}
    {{ end -}}{{/* if fnReturnType */}}

    {{/* TODO: generate arguments for methods with varargs */}}
}
{{ end }}

{{ if $c.IsKeyed -}}
/* TODO: implement keyed built-in classes

typedef void (*GDNativePtrKeyedSetter)(GDNativeTypePtr p_base, const GDNativeTypePtr p_key, const GDNativeTypePtr p_value);
typedef void (*GDNativePtrKeyedGetter)(const GDNativeTypePtr p_base, const GDNativeTypePtr p_key, GDNativeTypePtr r_value);


// keyed
func (cx *{{ $c.Name }}) SetKey(const Variant &p_key) Variant {

}
*/

{{ end -}}

{{ if and (gt (len $c.IndexingReturnType) 0) (contains $c.Name "Array") -}}
func (cx *{{ $c.Name }}) GetIndexed(i int64) {{ goReturnType $c.IndexingReturnType }} {

    var ret {{ goReturnType $c.IndexingReturnType }}

    CallFunc_GDNativePtrIndexedGetter(
        global{{ $c.Name }}MethodBindings.indexed_getter,
        (GDNativeTypePtr)(unsafe.Pointer(cx)),
        (GDNativeInt)(i),
        (GDNativeTypePtr)(unsafe.Pointer(&ret)),
    )

	return ret
}

func (cx *{{ $c.Name }}) SetIndexed(i int64, value {{ goReturnType $c.IndexingReturnType }}) {
    CallFunc_GDNativePtrIndexedSetter(
        global{{ $c.Name }}MethodBindings.indexed_setter,
        (GDNativeTypePtr)(unsafe.Pointer(cx)),
        (GDNativeInt)(i),
        (GDNativeTypePtr)(unsafe.Pointer(&value)),
    )
}
{{ end -}}

// members
{{ range $j, $m := $c.Members -}}
{{ $fnReturnType := goReturnType $m.Type }}
func (cx *{{ $c.Name }}) {{ goMethodName (print "MemberGet" $m.Name) }}() {{ $fnReturnType }} {
    bx := cx.ptr()
    return callBuiltinPtrGetter[{{ $fnReturnType }}](global{{ $c.Name }}MethodBindings.member_{{ $m.Name }}_getter, bx)
}
{{ end }}

{{ range $j, $op := $c.Operators -}}
// {{ upperFirstChar (getOperatorIdName $op.Name) }}{{ with $op.RightType }}_{{ $op.RightType }}{{ end }} operator
func (cx *{{ $c.Name }}) {{ upperFirstChar (getOperatorIdName $op.Name) }}{{ with $op.RightType }}_{{ $op.RightType }}{{ end }}(
    {{- if $op.RightType -}}
		right {{ goArgumentType $op.RightType }}
	{{- end -}}
) {{ goReturnType $op.ReturnType }} {
    lt := cx.ptr()
    {{ if gt (len $op.RightType) 0 -}}
    rt := (GDNativeTypePtr)(unsafe.Pointer(&right))
    return callBuiltinOperatorPtr[{{ goReturnType $op.ReturnType }}](global{{ $c.Name }}MethodBindings.operator_{{ getOperatorIdName $op.Name }}_{{ $op.RightType }}, lt, rt)
    {{ else -}}
    rt := (GDNativeTypePtr)(nullptr)
    return callBuiltinOperatorPtr[{{ goReturnType $op.ReturnType }}](global{{ $c.Name }}MethodBindings.operator_{{ getOperatorIdName $op.Name }}, lt, rt)
    {{ end -}}
}
{{ end -}}

{{ end -}}

func builtinClassesInitBindings() {
{{ range $i, $c := $view.FilterBuiltinClasses -}}
    {{ lowerFirstChar $c.Name }}InitBindings()
{{ end -}}
}
