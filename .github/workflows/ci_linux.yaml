name: godot-go CI on Linux

on:
  pull_request:
    paths:
      - "**/*.go"
      - "**/*.c"
      - "**/*.h"
      - ".github/workflows/ci.yaml"

  # push:
  #   paths:
  #     - "**/*.go"
  #     - "**/*.c"
  #     - "**/*.h"
  #     - ".github/workflows/ci.yaml"

jobs:
  run_test:
    name: "run tests"
    strategy:
      fail-fast: true
      matrix:
        go_version:
          - ${GOROOT_1_19_X64}
        targets:
          - linux/amd64
          # - darwin/amd64

    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Install tree
        run: sudo apt-get install -y tree
      # - name: Install libfontconfig
      #   run: sudo apt-get install -y libfontconfig libfreetype6 libexpat1 libuuid1 libpng16-16 libz3-4
      # - name: Update ldcache
      #   run: |
      #     sudo su -c 'rm -f /etc/ld.so.cache || true'
      #     sudo su -c ldconfig
      - name: Add Go 1.19.1 To System Path (${GOROOT_1_19_X64})
        run: |
          echo "${GOROOT_1_19_X64}/bin" >> $GITHUB_PATH
          echo "GITHUB_PATH=${GITHUB_PATH}"
      - name: Install Godot 4.0 beta 2
        run: |
          wget https://downloads.tuxfamily.org/godotengine/4.0/beta2/Godot_v4.0-beta2_linux.x86_64.zip
          sudo unzip Godot_v4.0-beta2_linux.x86_64.zip -d /usr/local/bin
          sudo ln -s Godot_v4.0-beta2_linux.x86_64 /usr/local/bin/godot4
      - name: Build
        run: make build
      - name: List Artifacts Directory
        run: |
          tree test/demo/
          tree test/demo/.godot
      - name: Gen Project Files
        timeout-minutes: 3
        run: make ci_gen_project_files
        continue-on-error: true
        env:
          CI: 1
          LOG_LEVEL: "debug"
          LANG: "en_US.utf8"
          GODOT: "/usr/local/bin/godot4"
      - name: Test
        timeout-minutes: 2
        run: make test
        env:
          CI: 1
          LOG_LEVEL: "debug"
          LANG: "en_US.utf8"
          GODOT: "/usr/local/bin/godot4"
